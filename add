#!/usr/bin/env sh

# Check if feature name is provided
if [ -z "$1" ]; then
    echo "Usage: $0 -f <feature>"
    exit 1
fi

# Parse command line arguments
while getopts "f:" opt; do
    case $opt in
        f)
            FEATURE=$OPTARG
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1
            ;;
    esac
done

if [ -z "$FEATURE" ]; then
    echo "Feature name is required. Usage: $0 -f <feature>"
    exit 1
fi

# Check if feature directory exists
if [ ! -d "$(dirname "$0")/features/$FEATURE" ]; then
    echo "Feature '$FEATURE' not found in features directory"
    exit 1
fi

# Copy feature to devcontainer/features
echo "Adding feature: $FEATURE"
mkdir -p ".devcontainer/features"
if [ -e .devcontainer/features/features.sh ]; then echo "features.sh found"; else cp "$(dirname "$0")/features/features.sh" ".devcontainer/features/features.sh"; fi;
cp -r "$(dirname "$0")/features/$FEATURE" ".devcontainer/features/$FEATURE"

# Add install.sh call to features.sh
echo "Adding feature installation to features.sh"
echo "bash /workspace/.devcontainer/features/$FEATURE/install.sh" >> ".devcontainer/features/features.sh"

echo "Feature '$FEATURE' added successfully"
